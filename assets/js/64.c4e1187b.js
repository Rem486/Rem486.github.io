(window.webpackJsonp=window.webpackJsonp||[]).push([[64],{414:function(t,s,a){"use strict";a.r(s);var n=a(40),e=Object(n.a)({},(function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h1",{attrs:{id:"node-日志管理"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#node-日志管理"}},[t._v("#")]),t._v(" node - 日志管理")]),t._v(" "),a("h2",{attrs:{id:"morgan"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#morgan"}},[t._v("#")]),t._v(" morgan")]),t._v(" "),a("p",[a("code",[t._v("morgan")]),t._v(" 是 "),a("code",[t._v("express")]),t._v(" 默认的日志中间件，也可以脱离 "),a("code",[t._v("express")]),t._v("，作为 "),a("code",[t._v("node.js")]),t._v(" 的日志组件单独使用。")]),t._v(" "),a("h3",{attrs:{id:"栗子"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#栗子"}},[t._v("#")]),t._v(" 栗子")]),t._v(" "),a("ol",[a("li",[t._v("安装依赖")])]),t._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[t._v("npm")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("install")]),t._v(" express morgan\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br")])]),a("ol",{attrs:{start:"2"}},[a("li",[t._v("添加示例代码")])]),t._v(" "),a("div",{staticClass:"language-js line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" express "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("require")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'express'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" app "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("express")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" morgan "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("require")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'morgan'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\napp"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("use")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("morgan")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'short'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\napp"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("use")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("req"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" res"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" next")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    res"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("send")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'ok'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\napp"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("listen")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("3000")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br")])]),a("p",[a("code",[t._v("node app.js")]),t._v(" 运行程序，并访问服务 "),a("code",[t._v("http://localhost:3000")]),t._v("，日志打印如下")]),t._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v('::1 - - [26/Sep/2021:07:35:16 +0000] "GET / HTTP/1.1" 304 - "-" "Mozilla/5.0"\n::1 - - [26/Sep/2021:07:35:16 +0000] "GET /favicon.ico HTTP/1.1" 200 2 "http://localhost:3000/" "Mozilla/5.0"\n')])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br")])]),a("h3",{attrs:{id:"日志格式"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#日志格式"}},[t._v("#")]),t._v(" 日志格式")]),t._v(" "),a("p",[a("code",[t._v("morgan")]),t._v(" 使用到的 API 基本只有一个 "),a("code",[t._v("morgan(format, options)")]),t._v("，栗子里已经使用了。")]),t._v(" "),a("p",[t._v("参数说明如下：")]),t._v(" "),a("ul",[a("li",[t._v("format：可选，"),a("code",[t._v("morgan")]),t._v(" 预定义了几种日志格式，每种格式都有对应的名称，比如 "),a("code",[t._v("combined")]),t._v("、"),a("code",[t._v("short")]),t._v(" 等，默认是 "),a("code",[t._v("default")]),t._v("。不同格式的差别可"),a("a",{attrs:{href:"https://github.com/expressjs/morgan/#predefined-formats",target:"_blank",rel:"noopener noreferrer"}},[t._v("参考"),a("OutboundLink")],1),t._v("。")]),t._v(" "),a("li",[t._v("options：可选，配置项，包含stream（常用）、skip、immediate。\n"),a("ul",[a("li",[t._v("stream：日志的输出流配置，默认是process.stdout。")]),t._v(" "),a("li",[t._v("skip：是否跳过日志记录，使用方式可以参考这里。")]),t._v(" "),a("li",[t._v("immediate：布尔值，默认是false。当为true时，一收到请求，就记录日志；如果为false，则在请求返回后，再记录日志。")])])])]),t._v(" "),a("h2",{attrs:{id:"pm2-logrotate"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#pm2-logrotate"}},[t._v("#")]),t._v(" pm2-logrotate")]),t._v(" "),a("p",[a("code",[t._v("pm2-logrotate")]),t._v(" 是 "),a("code",[t._v("pm2")]),t._v(" 的插件，用于自动切割日志，管理日志大小和数量等。")]),t._v(" "),a("h3",{attrs:{id:"pm2-日志配置"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#pm2-日志配置"}},[t._v("#")]),t._v(" pm2 日志配置")]),t._v(" "),a("p",[t._v("默认情况下，"),a("code",[t._v("pm2")]),t._v(" 已经会把日志记录在指定位置。并提供了几个配置选项，在 "),a("code",[t._v("app.json")]),t._v(" 中配置即可")]),t._v(" "),a("table",[a("thead",[a("tr",[a("th",[t._v("字段")]),t._v(" "),a("th",[t._v("类型")]),t._v(" "),a("th",[t._v("例子")]),t._v(" "),a("th",[t._v("描述")])])]),t._v(" "),a("tbody",[a("tr",[a("td",[t._v("error_file")]),t._v(" "),a("td",[t._v("(string)")]),t._v(" "),a("td"),t._v(" "),a("td",[t._v("error 日志文件路径 (default to $HOME/.pm2/logs/XXXerr.log)")])]),t._v(" "),a("tr",[a("td",[t._v("out_file")]),t._v(" "),a("td",[t._v("(string)")]),t._v(" "),a("td"),t._v(" "),a("td",[t._v("output 日志文件路径 (default to $HOME/.pm2/logs/XXXout.log)")])]),t._v(" "),a("tr",[a("td",[t._v("pid_file")]),t._v(" "),a("td",[t._v("(string)")]),t._v(" "),a("td"),t._v(" "),a("td",[t._v("pid 文件路径 (default to $HOME/.pm2/pid/app-pm_id.pid)")])]),t._v(" "),a("tr",[a("td",[t._v("merge_logs")]),t._v(" "),a("td",[t._v("boolean")]),t._v(" "),a("td",[t._v("true")]),t._v(" "),a("td",[t._v("如果是 "),a("code",[t._v("true")]),t._v(" 日志文件会放在在一起，不根据进程 id 来区分")])]),t._v(" "),a("tr",[a("td",[t._v("log_date_format")]),t._v(" "),a("td",[t._v("(string)")]),t._v(" "),a("td",[a("code",[t._v("YYYY-MM-DD HH:mm Z")])]),t._v(" "),a("td",[t._v("日志日期格式")])])])]),t._v(" "),a("h3",{attrs:{id:"安装和使用"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#安装和使用"}},[t._v("#")]),t._v(" 安装和使用")]),t._v(" "),a("ol",[a("li",[t._v("安装")])]),t._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("pm2 "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("install")]),t._v(" pm2-logrotate\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br")])]),a("ol",{attrs:{start:"2"}},[a("li",[t._v("使用\n安装好，之后就会直接已默认配置启用")])]),t._v(" "),a("p",[a("img",{attrs:{src:"/img/pm2-logrotate.png",alt:"pm2-logrotate"}})]),t._v(" "),a("ol",{attrs:{start:"3"}},[a("li",[t._v("设置参数\n"),a("code",[t._v("pm2 set pm2-logrotate:{paramName} {value}")])])]),t._v(" "),a("ul",[a("li",[t._v("max_size：单个日志文件的大小,可以设置 10G, 10M, 10K")]),t._v(" "),a("li",[t._v("retain：保留的日志文件个数，比如设置为 10 ,那么在日志文件达到 10 个后会将最早的日志文件删除掉")]),t._v(" "),a("li",[t._v("compress：是否通过 gzip 压缩日志")]),t._v(" "),a("li",[t._v("dateFormat：日志文件名中的日期格式，默认是YYYY-MM-DD_HH-mm-ss，注意是设置的日志名+这个格式，如设置的日志名为abc.log，那就会生成abc_YYYY-MM-DD_HH-mm-ss.log名字的日志文件")]),t._v(" "),a("li",[t._v("rotateModule：把 pm2 本身的日志也进行分割")]),t._v(" "),a("li",[t._v("workerInterval：设置检查日志大小的时间间隔，单位秒，最小为1")]),t._v(" "),a("li",[t._v("rotateInterval：设置分割日志的时间，默认值是0 0 * * *，意思是每天晚上0点分割")])]),t._v(" "),a("p",[t._v("设置完毕后可通过 "),a("code",[t._v("pm2 conf pm2-logrotate")]),t._v(" 来查看详细的配置。")]),t._v(" "),a("h3",{attrs:{id:"参考"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#参考"}},[t._v("#")]),t._v(" 参考")]),t._v(" "),a("ul",[a("li",[a("a",{attrs:{href:"https://www.cnblogs.com/chyingp/p/node-learning-guide-express-morgan.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("Node 进阶：express 默认日志组件 morgan 从入门使用到源码剖析"),a("OutboundLink")],1)]),t._v(" "),a("li",[a("a",{attrs:{href:"https://pm2.keymetrics.io/docs/usage/log-management/",target:"_blank",rel:"noopener noreferrer"}},[t._v("pm2 - Application Logs"),a("OutboundLink")],1)]),t._v(" "),a("li",[a("a",{attrs:{href:"https://www.cnblogs.com/daner1257/p/10763888.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://www.cnblogs.com/daner1257/p/10763888.html"),a("OutboundLink")],1)])])])}),[],!1,null,null,null);s.default=e.exports}}]);